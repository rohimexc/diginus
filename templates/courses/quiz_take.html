{% extends 'base.html' %}

{% block title %}Preview Quiz: {{ quiz.title }}{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto py-8">
    <div class="bg-white rounded-2xl shadow-sm border p-8">
        <div class="mb-8 border-b pb-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">{{ quiz.title }}</h1>
                <p class="text-sm text-gray-500">Minimal Skor: {{ quiz.passing_score }}%</p>
            </div>
            <div id="timer" class="text-xl font-mono font-bold text-blue-600">00:00</div>
        </div>

        <form id="quiz-form" class="space-y-8">
            <div id="questions-list" class="space-y-10">
                </div>

            <div class="pt-6 border-t">
                <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-200">
                    Kirim Jawaban
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const quizId = "{{ quiz.id }}";

    async function loadQuizForTaking() {
        const response = await fetch("{% url 'courses:api_quiz_data' quiz.id %}");
        const data = await response.json();
        const container = document.getElementById('questions-list');

        data.questions.forEach((q, index) => {
            let answersHtml = '';
            q.answers.forEach(a => {
                answersHtml += `
                    <label class="flex items-center p-4 border rounded-xl cursor-pointer hover:bg-blue-50 transition border-gray-100 mb-3 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50">
                        <input type="radio" name="question_${q.id}" value="${a.id}" class="w-4 h-4 text-blue-600 focus:ring-blue-500" required>
                        <span class="ml-4 text-gray-700 font-medium">${a.text}</span>
                    </label>`;
            });

            container.innerHTML += `
                <div class="question-item">
                    <h3 class="text-lg font-bold text-gray-900 mb-5 flex items-start">
                        <span class="mr-3 text-blue-600">${index + 1}.</span>
                        ${q.text}
                    </h3>
                    <div class="space-y-2">
                        ${answersHtml}
                    </div>
                </div>`;
        });
    }

    document.getElementById('quiz-form').onsubmit = async (e) => {
        e.preventDefault();
        const results = await confirmDelete('Kirim Jawaban?', 'Pastikan semua pertanyaan telah dijawab.');
        
        if (results.isConfirmed) {
            showLoading('Menilai...');
            const formData = new FormData(e.target);
            const userAnswers = {};
            
            // Konversi FormData ke JSON {question_id: answer_id}
            for (let [key, value] of formData.entries()) {
                userAnswers[key.replace('question_', '')] = value;
            }

            try {
                const response = await fetch("{% url 'courses:api_quiz_submit' quiz.id %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ answers: userAnswers })
                });

                const result = await response.json();
                
                // Tampilkan Hasil Menggunakan SweetAlert
                Swal.fire({
                    title: result.passed ? 'Selamat, Anda Lulus!' : 'Maaf, Anda Belum Lulus',
                    html: `<div class="text-4xl font-bold mb-2 ${result.passed ? 'text-green-500' : 'text-red-500'}">${result.score}%</div>
                           <p>Benar ${result.correct_count} dari ${result.total_questions} soal</p>`,
                    icon: result.passed ? 'success' : 'error',
                    confirmButtonText: 'Selesai Preview'
                }).then(() => {
                    window.location.href = "{% url 'courses:quiz_manager' quiz.module.id %}";
                });

            } catch (e) { showError('Gagal memproses penilaian.'); }
        }
    };

    document.addEventListener('DOMContentLoaded', loadQuizForTaking);
</script>
{% endblock %}